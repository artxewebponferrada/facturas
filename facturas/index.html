<!DOCTYPE html>
<html lang="es">
<head>
    <title>Factura - Lavado a Mano del Bierzo CB</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">

    <!-- External CSS libraries -->
    <link type="text/css" rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="assets/fonts/font-awesome/css/font-awesome.min.css">

    <!-- Favicon icon -->
    <link rel="shortcut icon" href="assets/img/favicon.ico" type="image/x-icon" >

    <!-- Google fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Custom Stylesheet -->
    <link type="text/css" rel="stylesheet" href="assets/css/style.css">

    <!-- Estilos Adicionales para Flexbox, Footer y Responsividad -->
    <style>
        /* Asegura que el contenedor invoice_wrapper use Flexbox */
        #invoice_wrapper {
            display: flex;
            flex-direction: column;
            background-color: #fff; /* Fondo blanco para una mejor apariencia en el PDF */
            padding: 20px;
            box-sizing: border-box;
            position: relative; /* Para posicionar el footer */
            min-height: 297mm; /* Altura de una página A4 */
        }

        /* Permite que el contenido principal se expanda */
        .invoice-content-main {
            flex: 1;
        }

        /* Asegura que los elementos con la clase d-print-none no se muestren en impresión o en el PDF */
        @media print {
            .d-print-none {
                display: none !important;
            }
        }

        /* Estilos para los campos editables */
        .editable-input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 1em;
            padding: 0;
            margin: 0;
            outline: none;
        }

        .editable-input:focus {
            border-bottom: 1px dashed #000;
        }

        /* Estilos adicionales para mejor apariencia */
        .invoice-table th, .invoice-table td {
            vertical-align: middle;
        }

        .invoice-table input {
            width: 100%;
        }


        /* Estilo para centrar el footer */
        .invoice-footer {
            text-align: center; /* Centra el contenido del footer */
            padding: 10px 0; /* Espaciado interno */
            border-top: 1px solid #ccc; /* Línea superior para separar el footer */
            font-size: 0.9em; /* Tamaño de fuente ligeramente menor */
            color: #555; /* Color de texto más suave */
            margin-top: auto; /* Empuja el footer al final del contenedor */
        }

        /* Estilo para el botón de agregar ítem */
        .btn-add-item {
            margin-bottom: 15px;
        }

        /* Media Queries para Responsividad en Dispositivos Móviles */
        @media (max-width: 768px) {
            /* Reducir tamaños de fuente en dispositivos móviles */
            body {
                font-size: 14px;
            }

            .invoice-table th, .invoice-table td {
                padding: 8px;
            }

            .invoice-footer {
                font-size: 0.8em;
            }

            /* Asegurar que los inputs ocupen el 100% del ancho disponible */
            .editable-input {
                font-size: 0.9em;
            }

            /* Ajustar el tamaño de los botones */
            .btn-add-item, .invoice-btn-section .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            /* Centrar el texto en la tabla para mejor legibilidad */
            .invoice-table th, .invoice-table td {
                text-align: left !important;
            }

            /* Permitir desplazamiento horizontal suave en la tabla */
            .table-responsive {
                overflow-x: auto;
            }
        }

        /* Estilo para el footer en el PDF */
        .pdf-footer {
            position: fixed;
            bottom: 10mm;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.8em;
            color: #555;
        }
    </style>
</head>
<body>

<!-- Invoice start -->
<div class="invoice-7 invoice-content">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <!-- Contenedor Principal de la Factura -->
                <div class="invoice-inner" id="invoice_wrapper">
                    <div class="invoice-content-main">
                        <!-- Encabezado de la factura -->
                        <div class="invoice-top">
                            <div class="row">
                                <div class="col-sm-6">
                                    <h3>Lavado a Mano del Bierzo CB</h3>
                                </div>
                                <div class="col-sm-6 final-texto">
                                    <div class="invoice text-end">
                                        <h1>Factura</h1>
                                        <p class="mb-1">N° de factura <input type="text" value="#1LUGO" class="editable-input" id="numero_factura"></p>
                                        <p class="mb-0">Fecha <br><input type="date" class="editable-input" id="fecha_factura"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Información de la factura -->
                        <div class="invoice-info">
                            <div class="row">
                                <div class="col-sm-6 mb-30">
                                    <div class="invoice-number">
                                        <h4 class="inv-title-1">Factura De</h4>
                                        <p class="invo-addr-1">
                                            <input type="text" value="Lavado a Mano del Bierzo CB" class="editable-input" id="factura_de_1"><br/>
                                            <input type="text" value="Avda Galicia 132, 3d" class="editable-input" id="factura_de_2"><br/>
                                            <input type="text" value="24404 Ponferrada CL, España" class="editable-input" id="factura_de_3"><br/>
                                            <input type="text" value="CIF: E24667024" class="editable-input" id="factura_de_4"><br/>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-sm-6 mb-30">
                                    <div class="invoice-number text-end final-texto">
                                        <h4 class="inv-title-1">Factura Para</h4>
                                        <p class="invo-addr-1">
                                            <input type="text" value="Autotransporte Turístico Español S.A." class="editable-input" id="factura_para_1"><br/>
                                            <input type="text" value="Avenida del Ensanche de Vallecas 27" class="editable-input" id="factura_para_2"><br/>
                                            <input type="text" value="28051 Madrid, España" class="editable-input" id="factura_para_3"><br/>
                                            <input type="text" value="CIF: A28047884" class="editable-input" id="factura_para_4"><br/>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6 mb-30">
                                    <h4 class="inv-title-1">Vencimiento</h4>
                                    <p class="inv-from-1">
                                        <input type="date" class="editable-input" style="text-align:left" id="vencimiento">
                                    </p>
                                </div>
                                <div class="col-sm-6 mb-30 text-end">
                                    <h4 class="inv-title-1">Forma de Pago</h4>
                                    <p class="inv-from-1 final-texto">
                                        <input type="text" value="Transferencia" class="editable-input" id="forma_pago">
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Resumen de la orden -->
                        <div class="order-summary">
                            <button type="button" class="btn btn-success btn-add-item d-print-none" data-html2canvas-ignore="true">
                                <i class="fa fa-plus"></i> Añadir fila
                            </button>
                            <div class="table-responsive">
                                <table class="table invoice-table">
                                    <thead class="bg-active">
                                        <tr>
                                            <th>Descripción</th>
                                            <th class="text-center">Cantidad</th>
                                            <th class="text-center">Precio (€)</th>
                                            <th class="text-right">Importe (€)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="item-row">
                                            <td>
                                                <div class="item-desc-1">
                                                    <input type="text" value="Lavado Turismo" class="editable-input descripcion">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" value="1" min="0" class="editable-input cantidad">
                                            </td>
                                            <td class="text-center">
                                                <!-- Precio por defecto cambiado de 369.00 a 9.00 -->
                                                <input type="number" value="9.00" min="0" step="0.01" class="editable-input precio">
                                            </td>
                                            <td class="text-right">
                                                <!-- Importe recalculado: 1 * 9.00 = 9.00 -->
                                                <input type="number" value="9.00" min="0" step="0.01" class="editable-input importe readonly-input" readonly>
                                            </td>
                                        </tr>
                                        <!-- Puedes clonar esta fila para agregar más ítems -->
                                        <tr>
                                            <td colspan="3" class="text-end">Subtotal</td>
                                            <!-- Subtotal recalculado: 9.00 -->
                                            <td class="text-right">
                                                <input type="number" value="9.00" min="0" step="0.01" class="editable-input subtotal readonly-input" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end">IVA (21%)</td>
                                            <!-- IVA recalculado: 9.00 * 0.21 = 1.89 -->
                                            <td class="text-right">
                                                <input type="number" value="1.89" min="0" step="0.01" class="editable-input iva readonly-input" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end fw-bold">Total</td>
                                            <!-- Total recalculado: 9.00 + 1.89 = 10.89 -->
                                            <td class="text-right fw-bold">
                                                <input type="number" value="10.89" min="0" step="0.01" class="editable-input total readonly-input" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end">Pagado</td>
                                            <!-- Pagado igual al Total por defecto: 10.89 -->
                                            <td class="text-right">
                                                <input type="number" value="10.89" min="0" step="0.01" class="editable-input pagado">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end">Total a Pagar</td>
                                            <!-- Total a Pagar recalculado: 10.89 - 10.89 = 0.00 -->
                                            <td class="text-right">
                                                <input type="number" value="0.00" min="0" step="0.01" class="editable-input total_pagar readonly-input" readonly>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Información de pago -->
                    </div>
                    <!-- Footer fuera del invoice_wrapper para no incluirlo en la captura -->
                    <footer class="invoice-footer d-print-none" data-html2canvas-ignore="true">
                        <p>CIF/NIF: E24667024 Móvil: 643 34 00 52 Email: mihai_lavado@yahoo.es</p>
                    </footer>
                    <!-- Botones de Acción (fuera del invoice_wrapper para no incluirlos en el PDF) -->
                    <div class="invoice-btn-section clearfix d-print-none mt-4" data-html2canvas-ignore="true">
                        <a id="invoice_download_btn" class="btn btn-lg btn-download btn-theme">
                            <i class="fa fa-download"></i> Descargar Factura
                        </a>
                        <a id="invoice_open_btn" class="btn btn-lg btn-primary btn-theme ms-2">
                            <i class="fa fa-eye"></i> Abrir Factura
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Invoice end -->

        <!-- Librerías de JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script>
            $(document).ready(function() {
                // Función para obtener la fecha actual en formato YYYY-MM-DD
                function getCurrentDate() {
                    var today = new Date();
                    var year = today.getFullYear();
                    var month = ('0' + (today.getMonth() + 1)).slice(-2);
                    var day = ('0' + today.getDate()).slice(-2);
                    return year + '-' + month + '-' + day;
                }

                // Función para actualizar el importe de cada fila
                function updateImporte(row) {
                    var cantidad = parseFloat(row.find('.cantidad').val()) || 0;
                    var precio = parseFloat(row.find('.precio').val()) || 0;
                    var importe = cantidad * precio;
                    row.find('.importe').val(importe.toFixed(2));
                }

                // Función para actualizar los totales
                function updateTotals() {
                    var subtotal = 0;
                    $('.importe').each(function() {
                        subtotal += parseFloat($(this).val()) || 0;
                    });
                    $('.subtotal').val(subtotal.toFixed(2));

                    var iva = subtotal * 0.21;
                    $('.iva').val(iva.toFixed(2));

                    var total = subtotal + iva;
                    $('.total').val(total.toFixed(2));

                    // Actualizar "Pagado" para que sea igual al "Total" por defecto
                    $('.pagado').val(total.toFixed(2));

                    // "Total a Pagar" siempre será 0 por defecto
                    $('.total_pagar').val("0.00");
                }

                // Función para actualizar "Total a Pagar" cuando se cambia "Pagado"
                function updateTotalPagar() {
                    var total = parseFloat($('.total').val()) || 0;
                    var pagado = parseFloat($('.pagado').val()) || 0;
                    var total_pagar = total - pagado;

                    // Evitar valores negativos
                    if (total_pagar < 0) {
                        total_pagar = 0;
                        $('.pagado').val(total.toFixed(2)); // Resetear "Pagado" al "Total"
                    }

                    $('.total_pagar').val(total_pagar.toFixed(2));
                }

                // Inicializar los valores de "Fecha", "Vencimiento", "Pagado" y "Total a Pagar"
                function initializeValues() {
                    var currentDate = getCurrentDate();
                    $('#fecha_factura').val(currentDate);
                    $('#vencimiento').val(currentDate);
                    updateTotals();
                }

                // Función para agregar una nueva fila de ítem debajo de la primera fila
                function addNewItemRow() {
                    // Clonar la primera fila de ítem
                    var firstItemRow = $('table.invoice-table tbody tr.item-row').first();
                    var newItemRow = firstItemRow.clone();

                    // Limpiar los valores de los inputs en la nueva fila
                    newItemRow.find('input').each(function() {
                        if ($(this).hasClass('descripcion')) {
                            $(this).val('');
                        } else if ($(this).hasClass('cantidad')) {
                            $(this).val('0');
                        } else if ($(this).hasClass('precio')) {
                            $(this).val('0.00');
                        } else if ($(this).hasClass('importe')) {
                            $(this).val('0.00');
                        }
                    });

                    // Insertar la nueva fila después de la primera fila de ítem
                    newItemRow.insertAfter(firstItemRow);
                }

                // Llamar a la función de inicialización al cargar la página
                initializeValues();

                // Manejar el evento de clic en el botón "Agregar Ítem"
                $('.btn-add-item').on('click', function() {
                    addNewItemRow();
                });

                // Actualizar importe y totales cuando se cambia cantidad o precio
                // Delegación de eventos para manejar dinámicamente las nuevas filas
                $('table.invoice-table tbody').on('input', '.cantidad, .precio', function() {
                    var row = $(this).closest('tr');
                    updateImporte(row);
                    updateTotals();
                });

                // Actualizar "Total a Pagar" cuando se cambia "Pagado"
                $('table.invoice-table tbody').on('input', '.pagado', function() {
                    updateTotalPagar();
                });

                // Función para generar PDF con Footer en cada página
                document.getElementById('invoice_download_btn').addEventListener('click', function () {
                    const invoiceWrapper = document.getElementById('invoice_wrapper');
                    html2canvas(invoiceWrapper, { scale: 2 }).then(function (canvas) {
                        var imgData = canvas.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;
                        var pdf = new jsPDF('p', 'mm', 'a4');
                        var imgWidth = 210; // Ancho A4 en mm
                        var pageHeight = pdf.internal.pageSize.getHeight(); // Altura A4 en mm
                        var imgHeight = canvas.height * imgWidth / canvas.width;
                        var heightLeft = imgHeight;
                        var position = 0;

                        // Número de páginas
                        var totalPages = Math.ceil(imgHeight / pageHeight);

                        for (var i = 0; i < totalPages; i++) {
                            if (i > 0) {
                                pdf.addPage();
                            }
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            
                            // Agregar el footer como texto
                            var footerText = "CIF/NIF: E24667024 Móvil: 643 34 00 52 Email: mihai_lavado@yahoo.es";
                            pdf.setFontSize(10);
                            pdf.text(footerText, imgWidth / 2, pageHeight - 10, { align: 'center' });
                            
                            heightLeft -= pageHeight;
                            position -= pageHeight;
                        }

                        // Guarda el PDF
                        pdf.save('factura.pdf');
                    }).catch(function(error){
                        console.error('Error al generar el PDF:', error);
                        alert('Ocurrió un error al generar el PDF. Revisa la consola para más detalles.');
                    });
                });

                // Función para abrir PDF en una nueva pestaña con Footer en cada página
                document.getElementById('invoice_open_btn').addEventListener('click', function () {
                    const invoiceWrapper = document.getElementById('invoice_wrapper');
                    html2canvas(invoiceWrapper, { scale: 2 }).then(function (canvas) {
                        var imgData = canvas.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;
                        var pdf = new jsPDF('p', 'mm', 'a4');
                        var imgWidth = 210; // Ancho A4 en mm
                        var pageHeight = pdf.internal.pageSize.getHeight(); // Altura A4 en mm
                        var imgHeight = canvas.height * imgWidth / canvas.width;
                        var heightLeft = imgHeight;
                        var position = 0;

                        // Número de páginas
                        var totalPages = Math.ceil(imgHeight / pageHeight);

                        for (var i = 0; i < totalPages; i++) {
                            if (i > 0) {
                                pdf.addPage();
                            }
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            
                            // Agregar el footer como texto
                            var footerText = "CIF/NIF: E24667024 Móvil: 643 34 00 52 Email: mihai_lavado@yahoo.es";
                            pdf.setFontSize(10);
                            pdf.text(footerText, imgWidth / 2, pageHeight - 10, { align: 'center' });
                            
                            heightLeft -= pageHeight;
                            position -= pageHeight;
                        }

                        // Obtener el Blob del PDF
                        var blob = pdf.output('blob');

                        // Crear un objeto URL para el Blob
                        var url = URL.createObjectURL(blob);

                        // Abrir el PDF en una nueva pestaña
                        window.open(url, '_blank');

                        // Liberar el objeto URL después de un tiempo para liberar memoria
                        setTimeout(function() {
                            URL.revokeObjectURL(url);
                        }, 1000);
                    }).catch(function(error){
                        console.error('Error al generar el PDF:', error);
                        alert('Ocurrió un error al generar el PDF. Revisa la consola para más detalles.');
                    });
                });
            });
        </script>
</body>
</html>
